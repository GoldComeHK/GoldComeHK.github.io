<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”é¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box; }
        
        body {font-family: 'Noto Serif TC', serif;background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);min-height: 100vh;display: flex;flex-direction: column;align-items: center;padding: 20px;color: #d4af37;position: relative;overflow-x: hidden; }
        
        body::before {content: "";position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: 
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 20%);z-index: -1; }
        
        a{text-decoration: none;}
        .container {max-width: 900px;width: 100%;display: flex;flex-direction: column;align-items: center;gap: 25px;position: relative;z-index: 10; }
        
        .header {text-align: center;margin-top: 15px;position: relative;width: 100%;padding: 30px 0; }
        
        .title {font-family: 'Noto Serif TC', serif;font-weight: 900;font-size: 4.8rem;background: linear-gradient(to right, #d4af37, #f9f295, #ffffff, #f9f295, #d4af37);background-clip: text; /* æ ‡å‡†å±æ€§ */-webkit-background-clip: text;-webkit-text-fill-color: transparent;text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);margin-bottom: 15px;position: relative;display: inline-block;letter-spacing: 5px; }
        
        .title::after {content: "âœ¨";position: absolute;top: -30px;right: -50px;font-size: 3rem;animation: sparkle 2s infinite;color: #f9f295;filter: drop-shadow(0 0 10px gold); }
        
        .title::before {content: "ğŸ’";position: absolute;top: -20px;left: -50px;font-size: 2.5rem;animation: sparkle 3s infinite 0.5s;color: #c0c0c0;filter: drop-shadow(0 0 10px silver); }
        
        .subtitle {font-size: 1.6rem;color: #e0e0e0;margin-bottom: 25px;letter-spacing: 3px;text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);font-weight: 400;position: relative; }
        
        .subtitle::after {content: "";display: block;width: 120px;height: 3px;background: linear-gradient(to right, transparent, #d4af37, #c0c0c0, #d4af37, transparent);margin: 15px auto 0;border-radius: 50%; }
        
        .main-content {display: flex;flex-direction: column;align-items: center;gap: 30px;width: 100%; }
        
        .camera-photo-container {position: relative;width: 100%;max-width: 500px;margin: 0 auto;border-radius: 20px;overflow: hidden;box-shadow: 
                0 0 40px rgba(212, 175, 55, 0.5),
                0 0 80px rgba(192, 192, 192, 0.3),
                inset 0 0 30px rgba(0, 0, 0, 0.8);background: rgba(15, 12, 41, 0.6);backdrop-filter: blur(12px);aspect-ratio: 3/4;border: 3px solid transparent;background-clip: padding-box; }
        
        .camera-photo-container::before {content: "";position: absolute;top: -3px; left: -3px; right: -3px; bottom: -3px;background: linear-gradient(45deg, #d4af37, #c0c0c0, #d4af37, #f9f295, #d4af37);border-radius: 20px;z-index: -1;animation: borderAnimation 6s infinite linear; }
        
        #video {width: 100%;height: 100%;display: block;object-fit: cover;background: linear-gradient(135deg, #1a162f, #0f0c29);transform: scaleX(-1); }
        
        #photoCanvas {position: absolute;top: 0;left: 0;width: 100%;height: 100%;display: none;object-fit: cover;background: linear-gradient(135deg, #1a162f, #0f0c29); }
        
        .camera-icon {position: absolute;bottom: 25px;left: 50%;transform: translateX(-50%);width: 80px;height: 80px;background: radial-gradient(circle, #d4af37, #8d6e0d);border-radius: 50%;display: flex;align-items: center;justify-content: center;box-shadow: 0 0 30px rgba(212, 175, 55, 0.9);cursor: pointer;z-index: 20;border: 3px solid #f9f295;transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .camera-icon:hover {transform: translateX(-50%) scale(1.15);box-shadow: 0 0 45px rgba(212, 175, 55, 1); }
        
        .camera-icon i {font-size: 36px;color: #fff;text-shadow: 0 0 8px rgba(0, 0, 0, 0.7); }
        
        .controls {display: flex;justify-content: center;gap: 25px;margin-top: 25px;width: 100%; }
        
        .btn {padding: 16px 35px;border: none;border-radius: 60px;font-family: 'Noto Serif TC', serif;font-weight: 700;font-size: 1.5rem;cursor: pointer;transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);display: flex;align-items: center;gap: 12px;box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);position: relative;overflow: hidden;z-index: 1;letter-spacing: 2px; }
        
        .btn::before {content: '';position: absolute;top: 0;left: 0;width: 100%;height: 100%;background: linear-gradient(45deg, #d4af37, #c0c0c0, #d4af37);z-index: -1;opacity: 0.9; }
        
        .btn::after {content: '';position: absolute;top: 3px;left: 3px;right: 3px;bottom: 3px;background: linear-gradient(135deg, #0f0c29, #302b63);border-radius: 60px;z-index: -1; }
        
        .btn span {color: #f9f295;text-shadow: 0 0 8px rgba(212, 175, 55, 0.7);position: relative;z-index: 2;font-weight: 700; }
        
        .btn i {color: #ffffff;text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);position: relative;z-index: 2;font-size: 1.8rem; }
        
        .btn:active {transform: translateY(5px);box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4); }
        
        /* ç»“æœåŒºåŸŸ */
        .results {background: rgba(15, 12, 41, 0.7);border-radius: 25px;padding: 30px;width: 100%;max-width: 600px;text-align: center;box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.7),
                inset 0 0 25px rgba(212, 175, 55, 0.4);backdrop-filter: blur(10px);border: 2px solid rgba(212, 175, 55, 0.4);position: relative; }
        
        .results::before {content: "";position: absolute;top: 0;left: 0;right: 0;height: 5px;background: linear-gradient(to right, transparent, #d4af37, #c0c0c0, #d4af37, transparent);border-radius: 5px; }
        
        .result-item {margin: 25px 0;padding: 20px;border-radius: 20px;background: rgba(30, 26, 60, 0.5);position: relative;overflow: hidden; }
        
        .result-item h3 {color: #f9f295;font-size: 2.1rem;margin-bottom: 20px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.5);font-weight: 700;letter-spacing: 3px; }
        
        .message {font-size: 2rem;color: #ffffff;line-height: 1.6;min-height: 100px;display: flex;align-items: center;justify-content: center;padding: 15px;text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);font-weight: 400;letter-spacing: 1px; }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .top-info-bar {position: absolute;top: 25px;left: 0;right: 0;display: flex;justify-content: space-between;padding: 0 25px;z-index: 30; }
        
        /* ç‚¹æ•°æŒ‰é’®æ ·å¼ */
        .points-btn {background: rgba(15, 12, 41, 0.8);border: 2px solid rgba(212, 175, 55, 0.6);color: #f9f295;font-size: 1.3rem;cursor: pointer;display: flex;align-items: center;gap: 8px;padding: 10px 20px;border-radius: 30px;transition: all 0.4s;font-family: 'Noto Serif TC', serif;font-weight: 700;box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);backdrop-filter: blur(8px);letter-spacing: 1px; }
        
        .points-btn:hover {background: rgba(212, 175, 55, 0.3);box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);transform: translateY(-3px); }
        
        .points-btn:active {transform: translateY(1px); }
        
        .points-value {font-size: 2rem;font-weight: 900;color: #ffffff;font-family: 'Noto Serif TC', serif;margin-left: 8px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.7); }
        
        /* è¯„åˆ†æ˜¾ç¤ºæ ·å¼ */
        .score-display {background: rgba(15, 12, 41, 0.8);border: 2px solid rgba(192, 192, 192, 0.6);color: #ffffff;font-size: 1.3rem;display: flex;align-items: center;gap: 8px;padding: 10px 20px;border-radius: 30px;font-family: 'Noto Serif TC', serif;font-weight: 700;box-shadow: 0 0 15px rgba(192, 192, 192, 0.3);backdrop-filter: blur(8px);letter-spacing: 1px; }
        
        .score-value {font-size: 2.5rem;font-weight: 900;color: #f9f295;font-family: 'Noto Serif TC', serif;margin-left: 8px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.7); }
        
        .gem-icon {color: #f9f295;margin-right: 8px;font-size: 1.6rem;text-shadow: 0 0 8px rgba(249, 242, 149, 0.7); }
        
        .footer {margin-top: 30px;text-align: center;color: #c0c0c0;font-size: 1.2rem;padding: 25px;background: rgba(15, 12, 41, 0.6);border-radius: 20px;width: 100%;max-width: 650px;box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.3);border: 2px solid rgba(212, 175, 55, 0.2);letter-spacing: 1px;line-height: 1.8; }
        
        /* è£…é¥°å…ƒç´  */
        .decoration {position: absolute;z-index: 1;opacity: 0.7;pointer-events: none; }
        
        .decoration.diamond {width: 90px;height: 90px;background: radial-gradient(circle, #fff, #c0c0c0);clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);top: 10%;left: 5%;animation: float 8s infinite ease-in-out;box-shadow: 0 0 30px rgba(192, 192, 192, 0.7);filter: blur(1px); }
        
        .decoration.gold-bar {width: 220px;height: 10px;background: linear-gradient(90deg, #d4af37, #f9f295, #d4af37);bottom: 15%;right: 5%;border-radius: 5px;animation: shine 3s infinite;box-shadow: 0 0 20px rgba(212, 175, 55, 0.7); }
        
        .decoration.silver-circle {width: 70px;height: 70px;border: 4px solid #c0c0c0;border-radius: 50%;bottom: 25%;left: 8%;box-shadow: 0 0 20px rgba(192, 192, 192, 0.7);animation: pulse 4s infinite; }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (min-width: 768px) {.title {    font-size: 5.5rem;}
            
            .subtitle {    font-size: 1.8rem;}
            
            .main-content {    flex-direction: row;    align-items: flex-start;    justify-content: center;}
            
            .results {    max-width: 380px;    margin-top: 40px;}
        }
        
        /* åŠ¨ç”» */
        @keyframes sparkle {0% { opacity: 0.3; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(0.9); }
        }
        
        @keyframes fadeIn {from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {0% { transform: scale(1); box-shadow: 0 0 15px rgba(212, 175, 55, 0.7); }
            50% { transform: scale(1.08); box-shadow: 0 0 35px rgba(212, 175, 55, 1); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(212, 175, 55, 0.7); }
        }
        
        @keyframes float {0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-25px) rotate(15deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        
        @keyframes shine {0% { background-position: -150px; }
            100% { background-position: 250px; }
        }
        
        @keyframes borderAnimation {0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in {animation: fadeIn 0.8s ease forwards; }
        
        .pulse {animation: pulse 2s infinite; }
        
        /* é‡ç½®æŒ‰é’®åŠ¨ç”» */
        @keyframes resetAnimation {0% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
            100% { transform: rotate(360deg); }
        }
        
        .reset-animation {animation: resetAnimation 0.8s ease; }
        
        /* ä¸‹è½½æŒ‰é’®åŠ¨ç”» */
        @keyframes downloadAnimation {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        .download-animation {
            animation: downloadAnimation 0.8s ease;
        }
        
        /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-message {
            color: #ff6b6b;
            font-size: 1.2rem;
            margin-top: 15px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- è£…é¥°å…ƒç´  -->
    <div class="decoration diamond"></div>
    <div class="decoration gold-bar"></div>
    <div class="decoration silver-circle"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">é­”é¡</h1>
            <p id="messageDisplay" class="subtitle">ç’€ç’¨å®¹é¡ Â· æ¥µè‡´è©•é‘‘</p>
        </div>

        <div id="login-form">
            <button onclick="loginWithGoogle()" class="btn"><i class="fa-brands fa-google"></i>ç™»å…¥</button>
            <div id="error-message" class="error-message"></div>
        </div>

        <div id="user-info" style="display: none;">
        </div>
        
        <div class="main-content">
            <div class="camera-photo-container">
                <!-- é¡¶éƒ¨ä¿¡æ¯æ  - å·¦ä¸Šè§’ç‚¹æ•°æŒ‰é’®ï¼Œå³ä¸Šè§’è¯„åˆ† -->
                <div class="top-info-bar">
                    <!-- å·¦ä¸Šè§’ç‚¹æ•°æŒ‰é’® -->
                    <a href="https://64071181.github.io/PayAki/" class="points-btn" id="pointsBtn">
                        <i class="fas fa-gem gem-icon"></i>
                        <span class="points-value user-score" id="pointsDisplay">0</span>
                    </a>
                    
                    <!-- å³ä¸Šè§’è¯„åˆ†æ˜¾ç¤º -->
                    <div class="score-display" id="scoreDisplay" style="display: none;">
                        è©•åˆ† <span class="score-value">--</span>
                    </div>
                </div>
                
                <video id="video" autoplay playsinline></video>
                <canvas id="photoCanvas"></canvas>
                <div class="camera-icon" id="captureBtn">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            
            <div class="controls">
                <button id="retakeBtn" class="btn" style="display:none;">
                    <i class="fas fa-redo"></i> 
                    <span>é‡æ–°æ‹æ”</span>
                </button>
                
                <!-- ä¸‹è½½æŒ‰é’® -->
                <button id="downloadBtn" class="btn" style="display:none;">
                    <i class="fas fa-download"></i> 
                    <span>ä¸‹è¼‰åœ–ç‰‡</span>
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>é­”é¡:çœŸå¯¦é­…åŠ›æºæ–¼è‡ªä¿¡èˆ‡æ°£è³ª</p>
        </div>
    </div>
    
    <div id="admin-panel" style="display: none;">
        <h2>ç®¡ç†å‘˜æ§åˆ¶å°
            <button onclick="logout()" style="background: #dc3545;">ç™»å‡º</button>
        </h2>
        
        <div class="user-controls">
            <input type="text" id="search-user" placeholder="æœç´¢ç”¨æˆ·IDæˆ–é‚®ç®±">
            <button onclick="searchUsers()">æœç´¢</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const video = document.getElementById('video');
            const photoCanvas = document.getElementById('photoCanvas');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const pointsDisplay = document.getElementById('pointsDisplay');
            const messageDisplay = document.getElementById('messageDisplay');
            const pointsBtn = document.getElementById('pointsBtn');
            const scoreValue = document.querySelector('.score-value');
            const errorMessage = document.getElementById('error-message');

            // åˆå§‹åŒ–ä¸Šä¸‹æ–‡
            const ctx = photoCanvas.getContext('2d');
            
            // å…¨å±€å˜é‡
            window.userPoints = window.userPoints || 0;
            pointsDisplay.textContent = window.userPoints;
            
            // å­˜å‚¨å½“å‰ç…§ç‰‡ä¿¡æ¯
            let currentPhotoInfo = {
                imageData: null,
                score: null,
                points: window.userPoints,
                message: ""
            };
            
            // è¯„è¯­æ•°ç»„ï¼ˆå…¨ç¹ä½“ï¼‰
            const messages = [
                "æ‚¨çš„å®¹é¡å¦‚é‘½çŸ³èˆ¬ç’€ç’¨ï¼Œç…§äº®äº†æ•´å€‹æ®¿å ‚ï¼",
                "ç²¾ç·»äº”å®˜é€£ç¶­ç´æ–¯å¥³ç¥ä¹Ÿè¦ç‚ºä¹‹å‚¾å€’ï¼",
                "é›™çœ¸é–ƒè€€å¦‚æ˜Ÿè¾°ï¼Œè˜Šè—è‘—ç„¡ç›¡æ™ºæ…§å…‰èŠ’ï¼",
                "é€™èˆ¬é«˜è²´æ°£è³ªï¼Œå®šæ˜¯å‡ºè‡ªçš‡å®¤è¡€è„ˆç„¡ç–‘ï¼",
                "å„ªé›…é¢¨ç¯„è®“é€™é¢é­”é¡éƒ½ç‚ºä¹‹è‘—è¿·å‚¾å¿ƒï¼",
                "å®Œç¾è¼ªå»“çŒ¶å¦‚è—è¡“å¤§å¸«çš„å·”å³°å‚‘ä½œï¼",
                "æ‚¨çš„å­˜åœ¨ï¼Œè®“é€™ä¸–ç•Œè®Šå¾—æ›´åŠ çµ¢éº—å¥ªç›®ï¼",
                "å¦‚æ­¤çµ•ä¸–å®¹é¡ï¼Œå ªç¨±åƒå¹´é›£é‡çš„çå¯¶ï¼",
                "æ‚¨çš„å¾®ç¬‘ï¼Œå‹éä¸–é–“æœ€çè²´çš„å¯¶çŸ³å…‰èŠ’ï¼",
                "éå‡¡æ°£è³ªå®šæ˜¯ç¹†æ–¯å¥³ç¥çš„æœ€é«˜æ©è³œï¼",
                "é­”é¡é­”é¡å‘Šè¨´æˆ‘ï¼Œèª°æ˜¯æœ€ç¾çš„äººï¼Ÿç•¶ç„¶æ˜¯å°Šè²´çš„æ‚¨ï¼",
                "æ‚¨çš„ç¾è²Œï¼Œé€£å¤ªé™½ç¥é˜¿æ³¢ç¾…ä¹Ÿè¦é»¯ç„¶å¤±è‰²ï¼",
                "é€™èˆ¬é«˜è²´æ°£è³ªï¼Œå®šæ˜¯å¥³ç¥é›…å…¸å¨œè½‰ä¸–é™è‡¨ï¼",
                "æ‚¨çš„å®¹é¡ï¼Œæ˜¯é€ ç‰©ä¸»æœ€å®Œç¾çš„è—è¡“çµæ™¶ï¼",
                "è¶…å‡¡è„«ä¿—çš„ç¾è²Œï¼Œåªæ‡‰å­˜åœ¨æ–¼å¤©ç•Œä»™å¢ƒï¼"
            ];
            
            // è¯·æ±‚æ‘„åƒå¤´è®¿é—®æƒé™
            async function initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    video.srcObject = stream;
                    
                    // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ç›¸åŒ
                    video.onloadedmetadata = function() {
                        photoCanvas.width = video.videoWidth;
                        photoCanvas.height = video.videoHeight;
                    };
                } catch (err) {
                    console.error("ç„¡æ³•è¨ªå•æ”åƒé ­: ", err);
                    errorMessage.textContent = "ç„¡æ³•è¨ªå•æ”åƒé ­ï¼Œè«‹ç¢ºä¿å·²æˆäºˆæ¬Šé™ä¸¦é‡è©¦ã€‚";
                }
            }
            
            // æ‹ç…§åŠŸèƒ½
            async function capturePhoto() {
                if (window.userPoints <= 0) {
                    errorMessage.textContent = "å¯¶çŸ³ä¸è¶³ï¼";
                    setTimeout(() => errorMessage.textContent = '', 3000);
                    return;
                }
                
                try {
                    // è°ƒç”¨redeemPointsæ‰£é™¤1ç‚¹
                    const result = await redeemPoints(1);
                    if (!result.success) {
                        errorMessage.textContent = "æ‰£é»å¤±æ•—: " + result.message;
                        setTimeout(() => errorMessage.textContent = '', 3000);
                        return;
                    }
                    
                    // æ›´æ–°ç‚¹æ•°æ˜¾ç¤º
                    window.userPoints = result.remainingPoints;
                    pointsDisplay.textContent = window.userPoints;
                    
                    // ç»˜åˆ¶é•œåƒç…§ç‰‡
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.drawImage(video, -photoCanvas.width, 0, photoCanvas.width, photoCanvas.height);
                    ctx.restore();
                    
                    // éšè—è§†é¢‘ï¼Œæ˜¾ç¤ºç”»å¸ƒ
                    video.style.display = 'none';
                    photoCanvas.style.display = 'block';
                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'flex';
                    downloadBtn.style.display = 'flex';
                    
                    // ç”Ÿæˆéšæœºåˆ†æ•° (88-100)
                    const score = Math.floor(Math.random() * 13) + 88;
                    scoreValue.textContent = score;
                    scoreValue.classList.add('pulse');
                    
                    // æ˜¾ç¤ºè¯„åˆ†
                    scoreDisplay.style.display = 'flex';
                    
                    // éšæœºé€‰æ‹©è¯„è¯­
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    messageDisplay.textContent = randomMessage;
                    
                    // ä¿å­˜å½“å‰ç…§ç‰‡ä¿¡æ¯
                    currentPhotoInfo = {
                        imageData: photoCanvas.toDataURL('image/png'),
                        score: score,
                        points: window.userPoints,
                        message: randomMessage
                    };
                    
                } catch (error) {
                    console.error("æ‹ç…§å¤±æ•—:", error);
                    errorMessage.textContent = "æ‹ç…§å¤±æ•—: " + error.message;
                    setTimeout(() => errorMessage.textContent = '', 3000);
                }
            }
            
            // é‡æ–°æ‹æ‘„
            function retakePhoto() {
                // æ˜¾ç¤ºè§†é¢‘ï¼Œéšè—ç”»å¸ƒ
                video.style.display = 'block';
                photoCanvas.style.display = 'none';
                captureBtn.style.display = 'flex';
                retakeBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                scoreDisplay.style.display = 'none';
                scoreValue.classList.remove('pulse');
            }
            
            // ä¸‹è½½å›¾ç‰‡
            function downloadPhoto() {
                if (!currentPhotoInfo.imageData) {
                    errorMessage.textContent = "æ²’æœ‰å¯ä¸‹è¼‰çš„ç…§ç‰‡";
                    setTimeout(() => errorMessage.textContent = '', 3000);
                    return;
                }
                
                // åˆ›å»ºä¸´æ—¶canvasæ¥ç»˜åˆ¶å¸¦æ°´å°çš„ç…§ç‰‡
                const downloadCanvas = document.createElement('canvas');
                downloadCanvas.width = photoCanvas.width;
                downloadCanvas.height = photoCanvas.height;
                const downloadCtx = downloadCanvas.getContext('2d');
                
                // ç»˜åˆ¶åŸå§‹ç…§ç‰‡
                const img = new Image();
                img.onload = function() {
                    downloadCtx.drawImage(img, 0, 0, downloadCanvas.width, downloadCanvas.height);
                    
                    // æ·»åŠ æ°´å°èƒŒæ™¯
                    downloadCtx.fillStyle = 'rgba(15, 12, 41, 0.7)';
                    downloadCtx.fillRect(0, downloadCanvas.height - 100, downloadCanvas.width, 100);
                    
                    // æ·»åŠ è¾¹æ¡†
                    downloadCtx.strokeStyle = '#d4af37';
                    downloadCtx.lineWidth = 3;
                    downloadCtx.strokeRect(0, 0, downloadCanvas.width, downloadCanvas.height);
                    
                    // æ·»åŠ è¯„åˆ†å’Œç‚¹æ•°ä¿¡æ¯
                    downloadCtx.font = 'bold 40px "Noto Serif TC", serif';
                    downloadCtx.textAlign = 'center';
                    
                    // æ·»åŠ è¯„åˆ†
                    downloadCtx.fillStyle = '#f9f295';
                    downloadCtx.shadowColor = 'rgba(249, 242, 149, 0.7)';
                    downloadCtx.shadowBlur = 10;
                    downloadCtx.fillText(`è©•åˆ†: ${currentPhotoInfo.score}`, downloadCanvas.width / 2, downloadCanvas.height - 60);
                    
                    // æ·»åŠ ç‚¹æ•°
                    downloadCtx.fillStyle = '#ffffff';
                    downloadCtx.shadowColor = 'rgba(255, 255, 255, 0.7)';
                    downloadCtx.fillText(`å¯¶çŸ³: ${currentPhotoInfo.points}`, downloadCanvas.width / 2, downloadCanvas.height - 20);
                    
                    // æ·»åŠ åº”ç”¨åç§°
                    downloadCtx.fillStyle = '#d4af37';
                    downloadCtx.font = 'bold 30px "Noto Serif TC", serif';
                    downloadCtx.fillText('é­”é¡è©•é‘‘', downloadCanvas.width / 2, 50);
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.download = `é­”é¡è©•é‘‘_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
                    link.href = downloadCanvas.toDataURL('image/png');
                    link.click();
                    
                    // æ·»åŠ ä¸‹è½½åŠ¨ç”»
                    downloadBtn.classList.add('download-animation');
                    setTimeout(() => {
                        downloadBtn.classList.remove('download-animation');
                    }, 800);
                };
                img.src = currentPhotoInfo.imageData;
            }

            // äº‹ä»¶ç›‘å¬
            captureBtn.addEventListener('click', capturePhoto);
            retakeBtn.addEventListener('click', retakePhoto);
            downloadBtn.addEventListener('click', downloadPhoto);
            
            // ç‚¹æ•°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            /*
            pointsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                errorMessage.textContent = "é»æ•¸ç”±ç³»çµ±ç®¡ç†ï¼Œç„¡æ³•é‡ç½®";
                setTimeout(() => errorMessage.textContent = '', 3000);
            });
            */

            // åˆå§‹åŒ–
            initCamera();
        });
        
        // FirebaseåŠŸèƒ½
        const firebaseConfig = {
            apiKey: "AIzaSyCya-DU6OYnWMuHrlvOALODnM8vmsR38F0",
            authDomain: "magicmirror0727.firebaseapp.com",
            projectId: "magicmirror0727",
            storageBucket: "magicmirror0727.firebasestorage.app",
            messagingSenderId: "895096216153",
            appId: "1:895096216153:web:434aa6633de30ad124ef48",
            measurementId: "G-JL07EBT0SJ"
        };
        
        // å…¨å±€å˜é‡
        window.userPoints = 0;
        const æ–°ç”¨æˆ¶é€åˆ† = 3;
        
        // Firebaseåˆå§‹åŒ–
        async function initFirebase() {
            // åŠ¨æ€å¯¼å…¥Firebaseæ¨¡å—
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js");
            const { 
                getAuth, 
                signInWithPopup, 
                GoogleAuthProvider, 
                onAuthStateChanged, 
                signOut 
            } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js");
            const { 
                getFirestore, 
                doc, 
                setDoc, 
                getDoc,
                updateDoc,
                increment,
                collection,
                addDoc,
                query,
                orderBy,
                limit,
                getDocs
            } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js");
            
            // åˆå§‹åŒ–Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // ç›‘å¬ç™»å½•çŠ¶æ€
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    
                    // åŠ è½½ç”¨æˆ·ç‚¹æ•°
                    await loadUserScore(user.uid, db, auth);
                } else {
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                }
            });
            
            // Googleç™»å½•
            window.loginWithGoogle = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    document.getElementById('error-message').textContent = translateError(error.code);
                }
            };
            
            // ç™»å‡º
            window.logout = async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    document.getElementById('error-message').textContent = translateError(error.code);
                }
            };
            
            // åŠ è½½ç”¨æˆ·åˆ†æ•°
            async function loadUserScore(userId, db, auth) {
                try {
                    const userRef = doc(db, "users", userId);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const score = userSnap.data().æœƒå“¡åˆ†æ•¸ || 0;
                        // è®¾ç½®å…¨å±€å˜é‡
                        window.userPoints = score;
                        document.querySelectorAll('.user-score').forEach(element => {
                            element.textContent = score;
                        });
                    } else {
                        // æ–°ç”¨æˆ·åˆå§‹åŒ–
                        await setDoc(userRef, {
                            email: auth.currentUser.email,
                            æœƒå“¡åˆ†æ•¸: æ–°ç”¨æˆ¶é€åˆ†
                        });
                        window.userPoints = æ–°ç”¨æˆ¶é€åˆ†;
                        document.querySelectorAll('.user-score').forEach(element => {
                            element.textContent = æ–°ç”¨æˆ¶é€åˆ†;
                        });
                    }
                } catch (error) {
                    console.error("è¼‰å…¥åˆ†æ•¸å¤±æ•—: " + error.message);
                    document.getElementById('error-message').textContent = "è¼‰å…¥åˆ†æ•¸å¤±æ•—: " + error.message;
                }
            }
            
            // å…‘æ¢ç‚¹æ•°
            window.redeemPoints = async (pointsToRedeem) => {
                const userId = auth.currentUser.uid;
                pointsToRedeem = Number(pointsToRedeem);
                
                // æ£€æŸ¥ä¼ å…¥çš„ pointsToRedeem æ˜¯å¦æœ‰æ•ˆ
                if (typeof pointsToRedeem !== 'number' || isNaN(pointsToRedeem) || pointsToRedeem <= 0) {
                    return { success: false, message: "ç„¡æ•ˆçš„åˆ†æ•¸" };
                }

                try {
                    const userRef = doc(db, "users", userId);
                    const userSnap = await getDoc(userRef);
                    const currentScore = userSnap.data().æœƒå“¡åˆ†æ•¸ || 0;
                    
                    if (currentScore < pointsToRedeem) {
                        return { success: false, message: `åˆ†æ•¸ä¸è¶³ (éœ€è¦ ${pointsToRedeem} åˆ†)` };
                    }
                    
                    if (pointsToRedeem <= 0) {
                        return { success: false, message: "ä½¿ç”¨åˆ†æ•¸å¿…é ˆå¤§æ–¼ 0" };
                    }
                    
                    await updateDoc(userRef, {
                        "æœƒå“¡åˆ†æ•¸": increment(-pointsToRedeem)
                    });
                    
                    // é‡æ–°åŠ è½½åˆ†æ•°
                    await loadUserScore(userId, db, auth);
                    
                    return { 
                        success: true, 
                        pointsUsed: pointsToRedeem, 
                        remainingPoints: currentScore - pointsToRedeem 
                    };
                } catch (error) {
                    console.error("ä½¿ç”¨å¤±æ•—: " + error.message);
                    return { success: false, error: error.message };
                }
            };
            
            // é”™è¯¯ç¿»è¯‘
            function translateError(code) {
                const errors = {
                    "auth/invalid-credential": "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤",
                    "auth/network-request-failed": "ç¶²è·¯é€£ç·šå¤±æ•—",
                    "auth/operation-not-allowed": "æ­¤ç™»å…¥æ–¹å¼æœªå•Ÿç”¨"
                };
                return errors[code] || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
            }
        }
        
        // åˆå§‹åŒ–Firebase
        initFirebase();
    </script>
</body>
</html>